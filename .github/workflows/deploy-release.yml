name: Deploy to Production (Release Branch)

on:
  push:
    branches:
      - release
  pull_request:
    branches:
      - release
    types: [closed]

env:
  GCP_PROJECT_ID: sqordia-api
  GCP_REGION: northamerica-northeast1
  IMAGE_NAME: gcr.io/sqordia-api/sqordia-backend
  SERVICE_NAME: sqordia-backend
  INSTANCE_NAME: sqordia-backend
  INSTANCE_ZONE: northamerica-northeast1-a

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == false)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore Sqordia.sln

      - name: Build
        run: dotnet build Sqordia.sln --no-restore -c Release

      - name: Run unit tests
        run: dotnet test Sqordia.sln --no-build --no-restore -c Release --verbosity normal --logger "trx;LogFileName=test-results.trx"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/test-results.trx'
          retention-days: 30

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker --quiet

      - name: Build and Push Docker image
        run: |
          docker buildx create --use --name multiarch-builder || true
          docker buildx build \
            --platform linux/amd64 \
            --tag ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --tag ${{ env.IMAGE_NAME }}:latest \
            --file Dockerfile \
            --push \
            .

  deploy:
    name: Deploy to Compute Engine
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Get Compute Engine instance details
        id: get-instance
        run: |
          INSTANCE_NAME=$(gcloud compute instances list \
            --filter="name:${{ env.INSTANCE_NAME }}" \
            --format="value(name)" \
            --zones=${{ env.INSTANCE_ZONE }} | head -1)
          
          if [ -z "$INSTANCE_NAME" ]; then
            echo "Instance not found"
            exit 1
          fi
          
          echo "instance_name=$INSTANCE_NAME" >> $GITHUB_OUTPUT
          echo "zone=${{ env.INSTANCE_ZONE }}" >> $GITHUB_OUTPUT

      - name: Stop and remove old container
        run: |
          gcloud compute ssh ${{ steps.get-instance.outputs.instance_name }} \
            --zone=${{ steps.get-instance.outputs.zone }} \
            --command="
              sudo docker stop sqordia-backend || true
              sudo docker rm sqordia-backend || true
            " \
            --quiet

      - name: Authenticate Docker on instance
        run: |
          gcloud compute ssh ${{ steps.get-instance.outputs.instance_name }} \
            --zone=${{ steps.get-instance.outputs.zone }} \
            --command="sudo gcloud auth configure-docker --quiet" \
            --quiet

      - name: Pull and run new container
        run: |
          gcloud compute ssh ${{ steps.get-instance.outputs.instance_name }} \
            --zone=${{ steps.get-instance.outputs.zone }} \
            --command="
              sudo docker pull ${{ env.IMAGE_NAME }}:${{ github.sha }}
              sudo docker run -d \
                --name sqordia-backend \
                --restart unless-stopped \
                -p 8080:8080 \
                -e ASPNETCORE_ENVIRONMENT=Production \
                -e ASPNETCORE_URLS=http://+:8080 \
                -e ConnectionStrings__DefaultConnection='${{ secrets.DB_CONNECTION_STRING }}' \
                -e Database__Provider=PostgreSQL \
                -e JwtSettings__Secret='${{ secrets.JWT_SECRET }}' \
                -e JwtSettings__Issuer=Sqordia \
                -e JwtSettings__Audience=SqordiaUsers \
                ${{ env.IMAGE_NAME }}:${{ github.sha }}
            " \
            --quiet

      - name: Wait for container to start
        run: sleep 15

      - name: Health check
        run: |
          INSTANCE_IP=$(gcloud compute instances describe ${{ steps.get-instance.outputs.instance_name }} \
            --zone=${{ steps.get-instance.outputs.zone }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          
          echo "Checking health at http://$INSTANCE_IP:8080/health"
          for i in {1..10}; do
            if curl -f http://$INSTANCE_IP:8080/health; then
              echo "✅ Health check passed!"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 5 seconds..."
            sleep 5
          done
          echo "❌ Health check failed after 10 attempts"
          exit 1

  migrate-database:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Get Compute Engine instance details
        id: get-instance
        run: |
          INSTANCE_NAME=$(gcloud compute instances list \
            --filter="name:${{ env.INSTANCE_NAME }}" \
            --format="value(name)" \
            --zones=${{ env.INSTANCE_ZONE }} | head -1)
          
          if [ -z "$INSTANCE_NAME" ]; then
            echo "Instance not found"
            exit 1
          fi
          
          echo "instance_name=$INSTANCE_NAME" >> $GITHUB_OUTPUT
          echo "zone=${{ env.INSTANCE_ZONE }}" >> $GITHUB_OUTPUT

      - name: Run database migrations
        run: |
          gcloud compute ssh ${{ steps.get-instance.outputs.instance_name }} \
            --zone=${{ steps.get-instance.outputs.zone }} \
            --command="
              echo 'Running database migrations...'
              sudo docker exec sqordia-backend dotnet ef database update \
                --project src/Infrastructure/Sqordia.Persistence \
                --startup-project src/WebAPI \
                --no-build \
                --connection '${{ secrets.DB_CONNECTION_STRING }}' || echo 'Migrations completed or no changes'
              echo 'Migrations completed'
            " \
            --quiet

      - name: Migration status
        run: |
          echo "✅ Database migrations completed successfully"

